{% comment %}
INITIALISE VARIABLES
{% endcomment %}
{% assign concerts = site.events.size %}
{% assign concertsAllM = 0 %}
{% assign worksperformed = 0 %}
{% assign worksperformedF = 0 %}
{% assign worksperformedM = 0 %}
{% assign relativeF = 0 %}
{% assign relativeM = 0 %}
{% assign relativeF_string = '' %}
{% assign urls_string = '' %}
{% assign dates_string = '' %}
{% assign performers_string = '' %}
{% assign earliestYear = site.time | date: '%Y' %}

{% comment %}
PROCESS EVENT DATA
{% endcomment %}
{% for event in site.events %}
  {% if event.programme %}

    {% assign eventworks = 0 %}
    {% assign eventF = 0 %}
    {% assign eventM = 0 %}

    {% for item in event.programme %}
      {% assign eventworks = eventworks | plus: 1 %}
      {% if item.gender == 'F' %}
        {% assign eventF = eventF | plus: 1 %}
      {% elsif item.gender == 'M' %}
        {% assign eventM = eventM | plus: 1 %}
      {% else %}
        <p>No gender entered: {{ item.composer }} — {{ item.work }}</p>
      {% endif %}
    {% endfor %}

    {% assign worksperformed = worksperformed | plus: eventworks %}
    {% assign worksperformedF = worksperformedF | plus: eventF %}
    {% assign worksperformedM = worksperformedM | plus: eventM %}

    {% assign event_relativeF = eventF | times: 1.00 | divided_by: eventworks %}
    {% assign relativeF = relativeF | plus: event_relativeF %}
    {% assign event_relativeM = eventM | times: 1.00 | divided_by: eventworks %}
    {% assign relativeM = relativeM | plus: event_relativeM %}

    {% assign relativeF_string = relativeF_string | append: event_relativeF | append: ' ' %}

    {% if event.url %}
        {% assign urls_string = urls_string | append: event.url | append: ' ' %}
      {% else %}
        {% assign urls_string = urls_string | append: '0' | append: ' ' %}
    {% endif %}

    {% if event.date %}
        {% assign eventdate = event.date | date: '%-d/%-m/%Y' %}
        {% assign dates_string = dates_string | append: eventdate | append: ' ' %}
      {% else %}
        {% assign dates_string = dates_string | append: '0' | append: ' ' %}
    {% endif %}

    {% if event.performer.name %}
        {% assign performers_string = performers_string | append: event.performer.name | append: '||' %}
      {% else %}
        {% assign performers_string = performers_string | append: '0' | append: '||' %}
    {% endif %}

    {% if eventF == 0 %}
      {% assign concertsAllM = concertsAllM | plus: 1 %}
    {% endif %}

  {% endif %}

  {% if event.date %}
    {% assign eventyear = event.date | date: '%Y' %}
    {% if eventyear < earliestYear %}
      {% assign earliestYear = eventyear %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign worksperformedF_percent = worksperformedF | times: 100.0 | divided_by: worksperformed | append: "" | truncate: 4, '' %}
{% assign worksperformedM_percent = worksperformedM | times: 100.0 | divided_by: worksperformed | append: "" | truncate: 4, '' %}
{% assign concertsAllM_percent = concertsAllM | times: 100.0 | divided_by: concerts | append: "" | truncate: 4, '' %}
{% assign relativeF = relativeF | divided_by: concerts | times: 100.0 | append: "" | truncate: 4, '' %}
{% assign relativeM = relativeM | divided_by: concerts | times: 100.0 | append: "" | truncate: 4, '' %}

{% assign relativeF_array = relativeF_string | split: ' ' %}
{% assign urls_array = urls_string | split: ' ' %}
{% assign dates_array = dates_string | split: ' ' %}
{% assign performers_array = performers_string | split: '||' %}

{% comment %}
  === AVAILABLE DATA TAGS ===
* {{ concerts }}                — the total number of concerts
* {{ concertsAllM }}            — the number of all-male concert programmes
* {{ concertsAllM_percent }}    — the percentage of concert programmes that are all male
* {{ earliestYear }}            — the earliest year an event occurred
* {{ worksperformed }}          — the total number of works performed
* {{ worksperformedF }}         — the total number of works by women performed
* {{ worksperformedF_percent }} — the percentage of works performed by women
* {{ worksperformedM }}         — the total number of works by men performed
* {{ worksperformedM_percent }} — the percentage of works performed by men
* {{ relativeF }}               — the average percentage of works by women per concert
* {{ relativeM }}               — the average percentage of works by men per concert
* {{ relativeF_array }}         — an array of the proportion of works by women for each concert
* {{ urls_array }}              — an array of event URLs matching {{ relativeF_array }}
* {{ dates_array }}             — an array of event dates matching {{ relativeF_array }}
* {{ performers_array }}        — an array of performer names matching {{ relativeF_array }}
{% endcomment %}

<h3>Since {{ earliestYear }} (when my records began)</h3>

<h4>Gender breakdown of composers of works performed</h4>
<p>Total number of works programmed: {{ worksperformed }}</p>
<ul class="chartlist">
  <li>
    <span class="label">Works by male composers</span>
    <span class="value">{{ worksperformedM }} ({{ worksperformedM_percent }}%)</span>
    <span class="percentage"style="width: {{ worksperformedM_percent }}%;"></span>
  </li>
  <li>
    <span class="label">Works by female composers</span>
    <span class="value">{{ worksperformedF }} ({{ worksperformedF_percent }}%)</span>
    <span class="percentage" style="width: {{ worksperformedF_percent }}%;"></span>
  </li>
</ul>

<h4>Number of all-male concert programmes</h4>
<p>Total number of concerts: {{ concerts }}</p>
<ul class="chartlist">
  <li>
    <span class="label">All-male programmes</span>
    <span class="value">{{ concertsAllM }} ({{ concertsAllM_percent }}%)</span>
    <span class="percentage"style="width: {{ concertsAllM_percent }}%;"></span>
  </li>
</ul>

<h4>The average concert programme</h4>
<ul class="chartlist">
  <li>
    <span class="label">Works by male composers</span>
    <span class="value">{{ relativeM }}%</span>
    <span class="percentage"style="width: {{ relativeM }}%;"></span>
  </li>
  <li>
    <span class="label">Works by female composers</span>
    <span class="value">{{ relativeF }}%</span>
    <span class="percentage" style="width: {{ relativeF }}%;"></span>
  </li>
</ul>

<h4>Proportion of works by female composers for every concert</h4>
<p><em>Clicking on a bar will take you to that concert’s detailed listing.</em></p>
<ul class="sparkchart donthyphenate">
  {% for fraction in relativeF_array reversed %}
    <li style="width: {{ 100.0 | divided_by: concerts }}%;">
      <a href="{{ urls_array[forloop.rindex0]}}">
        <span class="label" style="left: {{ -100.0 | times: forloop.rindex0 }}%; width: {{ concerts | times: 100 }}%;">
          {{ dates_array[forloop.rindex0] }}: {{ performers_array[forloop.rindex0] }}
        </span>
        <span class="percentage" style="height: {{ fraction | times: 100 }}%;">
      </a>
      <span class="separator"> — </span>
      <span class="value">
        {{ fraction | times: 100 | append: "" | truncate: 4, '' }}%
      </span>
    </li>
  {% endfor %}
</ul>
